name: Update TorrentBox Secrets

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM

jobs:
  update-secrets:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ssh-key: ${{ secrets.DEPLOY_KEY }}

      

      - name: Create base64 encoded secrets manifest
        run: |
          cat > kubernetes/base/torrentbox-secrets.yaml << EOF
          apiVersion: v1
          kind: Secret
          metadata:
            name: torrentbox-secrets
            namespace: torrentbox
          type: Opaque
          data:
            # qBittorrent credentials (base64 encoded)
            QBITTORRENT_PASSWORD: $(echo -n "${{ secrets.QBITTORRENT_PASSWORD }}" | base64 -w 0)
            QBITTORRENT_USERNAME: $(echo -n "${{ secrets.QBITTORRENT_USERNAME }}" | base64 -w 0)
            
            # API Keys / Tokens (base64 encoded)
            DISCORD_BOT: $(echo -n "${{ secrets.DISCORD_BOT_TOKEN }}" | base64 -w 0)
            RADARR_API: $(echo -n "${{ secrets.RADARR_API_KEY }}" | base64 -w 0)
            SONARR_API: $(echo -n "${{ secrets.SONARR_API_KEY }}" | base64 -w 0)
            
            # VPN credentials (base64 encoded)
            WIREGUARD_PRIVATE_KEY: $(echo -n "${{ secrets.WIREGUARD_PRIVATE_KEY }}" | base64 -w 0)
            
            # Plex credentials (base64 encoded)
            PLEX_CLAIM: $(echo -n "${{ secrets.PLEX_CLAIM }}" | base64 -w 0)
          EOF

      - name: Commit and push changes
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add kubernetes/base/torrentbox-secrets.yaml
          git commit -m "ğŸ”„ Update secrets from GitHub Actions [skip ci]" || exit 0
          git push